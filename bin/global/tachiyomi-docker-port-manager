#!/usr/bin/env sh

selected_container="$1"
tachidesk_path="$HOME/documents/github/docker-tachidesk"

check_if_any_container_running() {
  if [ -z "$(docker ps -q)" ]; then
    echo "No containers are running."
    exit 0
  fi
}

find_running_tachidesk_containers() {
  containers="mihon_personal mihon_private 
    tachiyomisy_personal tachiyomisy_private"

  exclude_container="$1"

  running_containers=""
  for container in $containers; do
    if [ "$container" = "$exclude_container" ]; then
      continue
    fi

    # Check if container is running
    running=$(docker ps --filter "name=${container}" \
      --format "{{.Names}}" | grep -w "${container}")

    if [ -n "$running" ]; then
      running_containers="$running_containers $container"
    fi
  done

  echo "$running_containers"
}

stop_containers_with_docker_compose() {
  running_containers="$1"

  for container in $running_containers; do
    echo "Stopping container ${container}"
    docker compose --project-directory "$tachidesk_path" --profile "$container" down
  done
}

main() {
  check_if_any_container_running

  running_containers=$(find_running_tachidesk_containers "$selected_container")

  if [ -n "$running_containers" ]; then
    stop_containers_with_docker_compose "$running_containers"
  else
    echo "No Tachidesk containers are running that need to be stopped."
  fi
}

main
